<div class="d-flex flex-row justify-content-center bd-highlight">

    <div class="col-sm-4">
        <label for="opcioneslista">Selecciona un Rubro a buscar</label>
        <select class="form-control" id="opcioneslista" name="opcioneslista"></select>
    </div>
</div>

<div class="col-sm-12">
    <div class="table-responsive">
        <table id="tablaanuncioslistaprecios" class="display table table-striped">
            <thead>
                <tr>
                    <th>Imagen</th>
                    <th>Precio</th>
                    <th>Título</th>
                    <th>Descripción</th>
                    <th>Rubro</th>
                    
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td ALIGN=center></td>
                    <td></td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>



    function configuraciontablalistaprecios()
    {
        $('#tablaanuncioslistaprecios').DataTable({
            "language": {

                "processing": "Procesando...",
                "search": "ESCRIBA AQUI ABAJO:",
                "lengthMenu": "Lista de anuncios",
                "info": "Registro: _START_ de _END_ - Total: _TOTAL_",
                "emptyTable": "No hay registros guardados",
                "zeroRecords": "No hay registros guardados",
                "infoEmpty": "No hay anuncios para mostrar",
                "paginate": {
                    "first": "Primera",
                    "previous": "Anterior",
                    "next": "Siguiente",
                    "last": "Ultima"
                },
                "aria": {
                    "sortAscending": "Ordenar columna ascendente",
                    "sortDescending": "Ordenar columna descendente"
                }
            },
            "pageLength": 29
            
        });
    }

    function consultaranuncioslista(e) 
    {
        var seleccion = document.getElementById("opcioneslista");
        var seleccionrubro = seleccion.options[seleccion.selectedIndex].text;
        
        var seleccionidrubro = document.getElementById("opcioneslista").value;


        if (seleccionrubro != "Seleccione un rubro") 
        {
            var bdd = conexionbddpaginaweb;
            var rutadeimagenes = rutaimagenespaginaweb;
            var tabla = tablaanunciospaginaweb;
            var tabladerubros = tablarubrospaginaweb;

            var tipo = "consultarubros";

            var t=null;

            if ($.fn.dataTable.isDataTable('#tablaanuncioslistaprecios'))
                t = $('#tablaanuncioslistaprecios').DataTable();
            else return;
            

            var id="";
            if (id == "") id = 0;
            else id = id;

            var itemanuncio = new Object();

            itemanuncio.bdd = bdd;
            itemanuncio.tabla = tabla;
            itemanuncio.tablarubros = tabladerubros;

            itemanuncio.tipo = tipo;
            itemanuncio.id = id;

            itemanuncio.titulo = "";
            itemanuncio.descripcion = "";
            itemanuncio.precio = "";
            itemanuncio.costo = "";
            itemanuncio.esnovedad = "";
            itemanuncio.esoferta = "";
            itemanuncio.nopublicar = "";
            itemanuncio.observaciones = "";
            itemanuncio.comentarios = "";

            itemanuncio.rutaimagenes = rutadeimagenes;
            itemanuncio.idrubro = seleccionidrubro;
            itemanuncio.imagen = "";
            itemanuncio.filtro = "";

            var objetoanuncio = JSON.stringify(itemanuncio);
            
            t.clear().draw(true);
            $.ajax({

                url: "consultaanuncios.php",

                data: { objetoanuncio: objetoanuncio},
                type: "post",

                success: function (data) 
                {
                    if (data != "consultavacia") {
                        dd = JSON.parse(data); //data decodificado
                        
                        $.each(dd, function (key, value) {
                            var precio;
                            if  (dd[key].precio > 0)
                                precio = "$ " + dd[key].precio;
                            else
                                precio = "Consultar Precio";

                            if (dd[key].nopublicar == 0)
                            {
                                t.row.add( [
                                    "<img class='materialboxed center-align' width='25px' src=" + "'" + rutaimagenes + dd[key].imagen + "'></img>",
                                    precio,
                                    dd[key].titulo,
                                    dd[key].descripcion,
                                    dd[key].rubro
                                    
                                
                                ] ).draw( false );

                                imageneszoom();
                            }
                        });
                        t.columns.adjust().draw();
                    }else{
                        M.toast(
                        {
                            html: 'No hay datos para mostrar!',
                            displayLength: '1500'
                        });
                    }
                },
                error: function (e) {
                    console.log("Error de comunicación");
                }
            });
        }
    }   

    $(document).ready(function () 
    {

         window.addEventListener("load", iniciolista());

        function iniciolista() {
            
            consultarubros_seleccion_listapaginaweb();
            configuraciontablalistaprecios();
           
        }

    });

    $("#opcioneslista").on('change', function () {

            consultaranuncioslista();
            M.toast(
                {
                    html: 'Buscando productos por rubro...',
                    displayLength: '3000'
                });
    });
</script>