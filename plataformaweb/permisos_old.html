<style>
    th{
        font-size: 0.9em;
    }
</style>
<br>
<div class="row justify-content-center">
    <div class="col-sm-4">
        <select class="form-control" id="listausuarios" name="listausuarios">

            <!-- aca se inserta la consulta de usuarios -->

        </select>
    </div>
</div>
<div class="row justify-content-center">
    <h5><small>Bloqueos de Visibilidad</small></h5>
</div>
<div class="row justify-content-center">

    <div class="col">
            <label><input id='chkCosto' onclick='checkPermiso(1,"chkCosto")' type='checkbox' class='filled-in' unchecked/><span class='colorletras'>Costo</span></label>
    </div>
    <div class="col">
        <label><input id='chkRenta' onclick='checkPermiso(2,"chkRenta")' type='checkbox' class='filled-in' unchecked /><span class='colorletras'>Rentabilidad</span></label>
    </div>
    <div class="col">
        <label><input id='chkStock' onclick='checkPermiso(3,"chkStock")' type='checkbox' class='filled-in' unchecked/><span class='colorletras'>Ver Stock</span></label>
    </div>
    <div class="col">
        <label><input id='chkElimina' onclick='checkPermiso(4,"chkElimina")' type='checkbox' class='filled-in' unchecked/><span class='colorletras'>Elimina</span></label>
    </div>
    <div class="col">
        <label><input id='chkCambiaPrecio' onclick='checkPermiso(5,"chkCambiaPrecio")' type='checkbox' class='filled-in' unchecked/><span class='colorletras'>Cambio Precios</span></label>
    </div>
</div>
<div class="row justify-content-center">
    <h5><small>Bloqueos de Menú</small></h5>
</div>
<div class="row justify-content-center">
    <div class="col">
        <label><input id='chkProducto' onclick='checkPermiso(100,"chkProducto")' type='checkbox' class='filled-in'       unchecked /><span class='colorletras'>Producto</span></label>
    </div>
    <div class="col">
        <label><input id='chkCategoria' onclick='checkPermiso(101,"chkCategoria")' type='checkbox' class='filled-in'
            unchecked /><span class='colorletras'>Categoria</span></label>
    </div>
    <div class="col">
        <label><input id='chkCliente' onclick='checkPermiso(102,"chkCliente")' type='checkbox' class='filled-in'
            unchecked /><span class='colorletras'>Cliente</span></label>
    </div>
    <div class="col">
        <label><input id='chkProveedor' onclick='checkPermiso(103,"chkProveedor")' type='checkbox' class='filled-in'
            unchecked /><span class='colorletras'>Proveedor</span></label>
    </div>
    <div class="col">
        <label><input id='chkVender' onclick='checkPermiso(104,"chkVender")' type='checkbox' class='filled-in'
            unchecked /><span class='colorletras'>Vender</span></label>
    </div>
    <div class="col">
        <label><input id='chkComprar' onclick='checkPermiso(105,"chkComprar")' type='checkbox' class='filled-in'
            unchecked /><span class='colorletras'>Comprar</span></label>
    </div>
</div>
<div class="row justify-content-center">
    <div class="col">
        <label><input id='chkCaja' onclick='checkPermiso(106,"chkCaja")' type='checkbox' class='filled-in'
            unchecked /><span class='colorletras'>Caja</span></label>
    </div>
    <div class="col">
        <label><input id='chkMStock' onclick='checkPermiso(107,"chkMStock")' type='checkbox' class='filled-in'
            unchecked /><span class='colorletras'>Stock</span></label>
    </div>
    <div class="col">
        <label><input id='chkActualizar' onclick='checkPermiso(108,"chkActualizar")' type='checkbox' class='filled-in'
            unchecked /><span class='colorletras'>Actualizar</span></label>
    </div>
    <div class="col">
        <label><input id='chkExport' onclick='checkPermiso(109,"chkExport")' type='checkbox' class='filled-in'
            unchecked /><span class='colorletras'>Export</span></label>
    </div>
    <div class="col">
        <label><input id='chkImport' onclick='checkPermiso(110,"chkImport")' type='checkbox' class='filled-in'
            unchecked /><span class='colorletras'>Import</span></label>
    </div>
    <div class="col">
        <label><input id='chkBonus' onclick='checkPermiso(111,"chkBonus")' type='checkbox' class='filled-in'
            unchecked /><span class='colorletras'>Bonus</span></label>
    </div>


</div>
<div class="row justify-content-center">
    <div class="col-sm-12">
        <h5><small>Bloqueos actuales de usuario</small></h5>
    </div>
</div>
<div class="row justify-content-center">

    <div class="col-sm-12">

        <div class="table-responsive">
            <table id="tablapermisos" class="display table table-striped" style="font-size: 0.9em;">
                <thead>
                    <tr>
                        <th>Id usuario</th>
                        <th>Costo</th>
                        <th>Rentab</th>
                        <th>Stock</th>
                        <th>Elimina</th>
                        <th>Cambia $</th>
                        <th>M-Producto</th>
                        <th>M-Categoría</th>
                        <th>M-Cliente</th>
                        <th>M-Proveedor</th>
                        <th>M-Vender</th>
                        <th>M-Comprar</th>
                        <th>M-Caja</th>
                        <th>M-Stock</th>
                        <th>M-Actualizar</th>
                        <th>M-Export</th>
                        <th>M-Import</th>
                        <th>M-Bonus</th>
                    </tr>
                </thead>
                <tbody >
                    <tr>
                        <td></td><td></td><td></td><td></td><td></td><td></td>
                        <td></td><td></td><td></td><td></td><td></td><td></td>
                        <td></td><td></td><td></td><td></td><td></td><td></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>

    var Costo; var Rentab; var Stock; var Elimina; var Cambia; var MProducto; var MCategoria; var MCliente; var MProveedor;
    var MVender; var MComprar; var MCaja; var MStock; var MActualizar; var MExport; var MImport; var MBonus;

function checkPermiso(bloqueopasado,che) {

    var ti;
    if(document.getElementById(che).checked == true)
        ti = "alta";
    else
        ti = "baja";

    if(idusuarioelegido > 0){


        var item = new Object();

        item.bdd = conexionbdd;
        item.tabla = tablabloqueos;
        item.tipo =ti;
        item.id = idusuarioelegido;
        item.bloqueo = bloqueopasado;
        var objeto = JSON.stringify(item);

        $.ajax({

            url: "consultabloqueos.php?" + versionts,
            data: { objeto: objeto },

            type: "post",

            success: function (data) {

                if (data != "consultavacia" && data != "[]") {
                    dd = JSON.parse(data); //data decodificado
                    BuscarPermisosPaqueteUsuarios();
                    buscarpermisousuarios();
                }
            },
            error: function (e) {
                alert("Error en la consulta." + e.value);
            }
        });
    }else{
        M.toast({ html: 'Seleccione un usuario de la lista', displayLength: '500', classes: 'rounded' });
        // destilda();
    }

}

function consultausuarioplataforma() {

    objeto = new Object();
    objeto.tipo = "consultausuarioplataforma";
    objeto.idplataformaactual = idplataformaactual;
    objeto.id = 0;

    var objetojson = JSON.stringify(objeto);

    $("#listausuarios").empty();

    $.ajax({

        url: "usuarios.php?" + versionts,
        data: { objetojson: objetojson },

        type: "post",

        success: function (data) {

            if (data != "consultavacia" && data != "[]") {
                dd = JSON.parse(data); //data decodificado

                // tr.clear().draw(true);
                var idanterior = -1;
                arreglousuario = [];
                var a = [];
                a.push('<option value = "" selected >Usuarios</option >');

                $.each(dd, function (key, value) {

                    if (idanterior != dd[key].idusuario) {
                        if (idanterior != dd[key].idusuario) {
                            idanterior = dd[key].idusuario;

                            var item = new Object();
                            item.idusuario = dd[key].idusuario;
                            item.email = dd[key].email;
                            item.idplataforma = dd[key].idplataforma;
                            var objetoJsonItem = JSON.stringify(item);
                            arreglousuario.push(objetoJsonItem);

                            a = a.concat('<option value = ' + dd[key].idusuario + ' > ' +  dd[key].idusuario + " " + dd[key].email + '</option>');

                        }
                    }
                });

                $("#listausuarios").append(a);

                //selecciona el primer item
                $("#listausuarios option:selected").prop("selected", false);
                $(this).prop("selected", true);

                BuscarPermisosPaqueteUsuarios();
                setTimeout(function(){destilda();},2000);
            }
        },
        error: function (e) {
            alert("Error en la consulta." + e.value);
        }
    });

    
}

$("#listausuarios").change(function () {
    idusuarioelegido = $("#listausuarios").val();
    buscarpermisousuarios();
});

function tilda(tilde){
    document.getElementById(tilde).checked = true;
}
function destilda() {
   
    document.getElementById("chkCosto").checked = false;
    document.getElementById("chkRenta").checked = false;
    document.getElementById("chkStock").checked = false;
    document.getElementById("chkElimina").checked = false;
    document.getElementById("chkCambiaPrecio").checked = false;
    document.getElementById("chkProducto").checked = false;
    document.getElementById("chkCategoria").checked = false;
    document.getElementById("chkCliente").checked = false;
    document.getElementById("chkProveedor").checked = false;
    document.getElementById("chkVender").checked = false;
    document.getElementById("chkComprar").checked = false;
    document.getElementById("chkCaja").checked = false;
    document.getElementById("chkMStock").checked = false;
    document.getElementById("chkActualizar").checked = false;
    document.getElementById("chkExport").checked = false;
    document.getElementById("chkImport").checked = false;
    document.getElementById("chkBonus").checked = false;
}

function blanquea(){
    Costo = ""; Rentab = ""; Stock = ""; Elimina = ""; Cambia = "";
    MProducto = ""; MCategoria = ""; MCliente = ""; MProveedor = "";
    MVender = ""; MComprar = ""; MCaja = ""; MStock = ""; MActualizar = "";
    MExport = ""; MImport = ""; MBonus = "";
}
function buscarpermisousuarios(){

    var item = new Object();
    item.bdd = conexionbdd;
    item.tabla = tablabloqueos;
    item.tipo = "consultar";
    item.id = idusuarioelegido;
    var objeto = JSON.stringify(item);

    destilda();

    $.ajax({

        url: "consultabloqueos.php?" + versionts,
        data: { objeto: objeto},
        type: "post",

        success: function (data) {

            if (data != "consultavacia" && data != "[]") {

                dd = JSON.parse(data);
                var usuarioanterior = -1;
                var candado = "<i style='text-align: center;' class=" + "\"material-icons\"" + ">lock</i>"

                $.each(dd, function (key, value) {
                    if (dd[key].bloqueo == 1) { tilda("chkCosto"); }
                    if (dd[key].bloqueo == 2) { tilda("chkRenta"); }
                    if (dd[key].bloqueo == 3) { tilda("chkStock"); }
                    if (dd[key].bloqueo == 4) { tilda("chkElimina"); }
                    if (dd[key].bloqueo == 5) { tilda("chkCambiaPrecio"); }

                    if (dd[key].bloqueo == 100) { tilda("chkProducto"); }
                    if (dd[key].bloqueo == 101) { tilda("chkCategoria"); }
                    if (dd[key].bloqueo == 102) { tilda("chkCliente"); }
                    if (dd[key].bloqueo == 103) { tilda("chkProveedor"); }
                    if (dd[key].bloqueo == 104) { tilda("chkVender"); }
                    if (dd[key].bloqueo == 105) { tilda("chkComprar"); }
                    if (dd[key].bloqueo == 106) { tilda("chkCaja"); }
                    if (dd[key].bloqueo == 107) { tilda("chkMStock"); }
                    if (dd[key].bloqueo == 108) { tilda("chkActualizar"); }
                    if (dd[key].bloqueo == 109) { tilda("chkExport"); }
                    if (dd[key].bloqueo == 110) { tilda("chkImport"); }
                    if (dd[key].bloqueo == 111) { tilda("chkBonus"); }
                });
            }
        }
        ,
        error: function (e) {
            console.log("Error en la consulta." + e.value);
        }
    });
}

function BuscarPermisosPaqueteUsuarios() {
    if ($.fn.dataTable.isDataTable('#tablapermisos')) {
        var tr = $('#tablapermisos').DataTable();
    }

    var item = new Object();
    item.bdd = conexionbdd;
    item.tabla = tablabloqueos;
    item.tipo = "consultapaquete";
    item.id = idusuarioelegido;
    var objeto = JSON.stringify(item);

    // M.toast({ html: 'Buscando permisos', displayLength: '1000', classes: 'rounded' });
    tr.clear().draw(true);
    destilda();

    $.ajax({

        url: "consultabloqueos.php?" + versionts,
        data: { objeto: objeto, arreglousuario: arreglousuario },
        type: "post",

        success: function (data) {

            if (data != "consultavacia" && data != "[]") {

                //data llega como arreglo de jsons
                tr.clear().draw(true);
                var idanterior = -1;

                dd = JSON.parse(data); //es el json
                ddd = JSON.parse(data); //es el json
                var usuarioanterior=-1;
                var candado = "<i style='text-align: center;' class=" + "\"material-icons\"" + ">lock</i>"
                
                blanquea();

                var contador = 0;
                $.each(ddd, function (key, value) {
                    if (usuarioanterior == -1) {
                        usuarioanterior = dd[key].idusuario;
                    }
                    contador = contador + 1;
                });

                var cuenta = 0;

                $.each(dd, function (key, value)
                {
                    cuenta = cuenta + 1;

                    if(usuarioanterior == dd[key].idusuario)
                    {
                        if (dd[key].bloqueo == 1) {Costo = candado; }
                        if (dd[key].bloqueo == 2) {Rentab = candado;}
                        if (dd[key].bloqueo == 3) {Stock = candado; }
                        if (dd[key].bloqueo == 4) {Elimina = candado;}
                        if (dd[key].bloqueo == 5) {Cambia = candado; }

                        if (dd[key].bloqueo == 100){ MProducto = candado;}
                        if (dd[key].bloqueo == 101){ MCategoria = candado;}
                        if (dd[key].bloqueo == 102){ MCliente = candado; }
                        if (dd[key].bloqueo == 103){ MProveedor = candado;}
                        if (dd[key].bloqueo == 104){ MVender = candado;}
                        if (dd[key].bloqueo == 105){ MComprar = candado;}
                        if (dd[key].bloqueo == 106){ MCaja = candado;}
                        if (dd[key].bloqueo == 107){ MStock = candado; }
                        if (dd[key].bloqueo == 108){ MActualizar = candado;}
                        if (dd[key].bloqueo == 109){ MExport = candado; }
                        if (dd[key].bloqueo == 110){ MImport = candado;}
                        if (dd[key].bloqueo == 111){ MBonus = candado; }
                    }

                    if(cuenta == contador || usuarioanterior != dd[key].idusuario)
                    {
                        //guarda el registro anterior
                        if(usuarioanterior != dd[key].idusuario)
                        {
                            tr.row.add([
                                usuarioanterior, Costo, Rentab, Stock, Elimina, Cambia,
                                MProducto, MCategoria, MCliente, MProveedor, MVender,
                                MComprar, MCaja, MStock, MActualizar, MExport, MImport, MBonus
                            ]).draw(false);
                            usuarioanterior = dd[key].idusuario;
                            
                            blanquea();
                            if (dd[key].bloqueo == 1) { Costo = candado; }
                            if (dd[key].bloqueo == 2) { Rentab = candado; }
                            if (dd[key].bloqueo == 3) { Stock = candado; }
                            if (dd[key].bloqueo == 4) { Elimina = candado; }
                            if (dd[key].bloqueo == 5) { Cambia = candado; }

                            if (dd[key].bloqueo == 100) { MProducto = candado; }
                            if (dd[key].bloqueo == 101) { MCategoria = candado; }
                            if (dd[key].bloqueo == 102) { MCliente = candado; }
                            if (dd[key].bloqueo == 103) { MProveedor = candado; }
                            if (dd[key].bloqueo == 104) { MVender = candado; }
                            if (dd[key].bloqueo == 105) { MComprar = candado; }
                            if (dd[key].bloqueo == 106) { MCaja = candado; }
                            if (dd[key].bloqueo == 107) { MStock = candado; }
                            if (dd[key].bloqueo == 108) { MActualizar = candado; }
                            if (dd[key].bloqueo == 109) { MExport = candado; }
                            if (dd[key].bloqueo == 110) { MImport = candado; }
                            if (dd[key].bloqueo == 111) { MBonus = candado; }
                        }

                        usuarioanterior == dd[key].idusuario;

                        //es el ultimo registro
                        if(cuenta == contador)
                        {
                            if (dd[key].bloqueo == 1) { Costo = candado; }
                            if (dd[key].bloqueo == 2) { Rentab = candado; }
                            if (dd[key].bloqueo == 3) { Stock = candado; }
                            if (dd[key].bloqueo == 4) { Elimina = candado; }
                            if (dd[key].bloqueo == 5) { Cambia = candado; }

                            if (dd[key].bloqueo == 100) { MProducto = candado; }
                            if (dd[key].bloqueo == 101) { MCategoria = candado; }
                            if (dd[key].bloqueo == 102) { MCliente = candado; }
                            if (dd[key].bloqueo == 103) { MProveedor = candado; }
                            if (dd[key].bloqueo == 104) { MVender = candado; }
                            if (dd[key].bloqueo == 105) { MComprar = candado; }
                            if (dd[key].bloqueo == 106) { MCaja = candado; }
                            if (dd[key].bloqueo == 107) { MStock = candado; }
                            if (dd[key].bloqueo == 108) { MActualizar = candado; }
                            if (dd[key].bloqueo == 109) { MExport = candado; }
                            if (dd[key].bloqueo == 110) { MImport = candado; }
                            if (dd[key].bloqueo == 111) { MBonus = candado; }
                             tr.row.add([
                                usuarioanterior, Costo, Rentab, Stock, Elimina, Cambia,
                                MProducto, MCategoria, MCliente, MProveedor, MVender,
                                MComprar, MCaja, MStock, MActualizar, MExport, MImport, MBonus
                            ]).draw(false);
                        }
                    }
                });

            }
        }
        ,
        error: function (e) {
            console.log("Error en la consulta." + e.value);
        }
    });
}

$(document).ready(function ()
{
    llama = "permisos";
    arreglousuario = [];
    idusuarioelegido= 0;

    window.addEventListener("load", iniciolista());

    function iniciolista() {
        // configuraciontablausuarios();
        configuraciontablapermisos();
        consultausuarioplataforma();
    }
});

</script>