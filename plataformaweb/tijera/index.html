<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Recorte de imagen</title>
    
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
    integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <!-- para mostrar los toast -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@9.4.3/dist/sweetalert2.all.min.js"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/jcrop/dist/jcrop.css">

    <link rel="stylesheet" href="esteticatijera.css">
    
    <script src="https://unpkg.com/jcrop"></script>

</head>
<body>



<form action="" id="formularioimagen" method="POST" role="form" enctype="multipart/form-data">
    <div id="titulotijera" class="row">
        <div class="col center">
            <div class="row justify-content-center">
                <div class="col-sm-6 center">
                    <h5>Corte una imagen en tres pasos</h5>
                </div>
            </div>
            <div class="row justify-content-center">
                <div class="col-sm-2 center"></div>
                <div class="col-sm-8 center">
                    <p>Sube una image, Recorta y Guarda</p>
                </div>
                <div class="col-sm-2 center">
                    <button  id="nuevotijera" class="btn btn-sucess ">Nuevo</button>
                </div>
            </div>
        </div>
    </div>

    <seccion id="seccionrecorte" class="row justify-content-center" style="display: none;">
        <div class="col-sm-12">
            <div class="row justify-content-center">
                <p class="p-3">Arrastra sobre la imagen para marcar la zona de recorte</p>
            </div>
            <div class="row justify-content-center">
                <div class="col-sm-3"></div>
                <div class="col-sm-6">
                    <div class="row justify-content-center">
                        <label>Ancho<input type="text" name="w" id="w" size="4" readonly /></label>
                        <label>Alto<input type="text" name="h" id="h" size="4" readonly /></label>
                        <label>Tamaño de archivo (MB)<input type="text" name="tamanioarchivo" id="tamanioarchivo" size="4" readonly /></label>
                    </div>
                </div>
                <div class="col-sm-3">
                    <div class="row justify-content-center">
                        <!-- <input class="form-group mb-2" style="padding:20px;"> -->
                        <input class="btn btn-primary" type='button' id="recortar"
                        value='Rectortar Imagen'>
                    </div>
                </div>
                
               
            </div>
        </div>

    </seccion>

    <div id="secciondescarga" class="row justify-content-center"  style="display: none;">
        <input class="btn btn-primary" type='button' id="descargar"
            value='Descargar Imagen'>
    </div>

    <seccion id="seccionseleccion" class="row container">
        <div class="col-sm-12">
            
            <div class="row justify-content-center">
                <p>
                    <label>
                        <input id="escuadrada" type="checkbox" class="filled-in" checked="checked"/>
                        <span> Corte de imagen cuadrada</span>
                    </label>
                </p>
               
            </div>
            <div class="row justify-content-center">
                <label for="imagen">SELECCIONA UNA IMAGEN</label>
            </div>
            <div class="row justify-content-center">
                <div class="form-group">
                    <input class="grey lighten-3 pt-2" value="Ninguna imagen cargada" class="form-control" type="file" id="imagen"
                        name="imagen" required>
                    <progress class="progress" id="barra" value="0" max="100">0%</progress>
                    <label for="" id="valorbarra">0%</label>
                    <p class="red-text accent-4" id="aviso"></p>
                </div>
            </div>
        </div>
    </seccion>

    <seccion id="seccionimagenprincipal" class="row container">
        <div class="col-sm-12">
            <div class="row justify-content-center">
                <div id="carga"></div>

                <!-- aca inserta un jcrop automatico la misma clase -->
                <img class="img-fluid" id="muestraoriginal" src="agregarimagen.jpg">
                <!-- fin del jcrop -->
            </div>
        </div>
        
        
    </seccion>

    <seccion id="seccionrecortada" class="row justify-content-center"  style="display: none;">
        <div class="col-sm-12 center">
            <img class="img-fluid" src="#" id="imagenrecortada">
        </div>
    </seccion>
 
    <img id="original" src="" style="display: none;">

</form>

<!-- mensajes de sweetalert -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

<script src="https://code.jquery.com/jquery-3.5.1.js" integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc="
    crossorigin="anonymous"></script>
<!--     
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
    integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
    crossorigin="anonymous"></script> -->
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
    integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
    crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"
    integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI"
    crossorigin="anonymous"></script>
    


</body>
</html>

<script>
    tamanio ="";
    muestra="";
    muestrarecortador="";

    anchoenvista = 0;
    altoenvista = 0;
    anchooriginal = 0;
    altooriginal = 0;
    
    factorescalaancho=0;
    factorescalaalto=0;

   

    function validarcambioimagen() {

        var imagen = document.getElementById('imagen');
        imagen.onchange = function (e) { validarimagen(e); }
    }

    validarcambioimagen();

    function validarimagen(e)
    {
        archivo = e.target.files[0];

        var extensiones = ["jpg", "PNG", "png", "jpeg"];
        var verTam = function (mega) {
            return Math.pow(3, 20) * mega; //2 a la 20 da 1048576 que es 1Mb
        }

        extension = archivo.type.split('/').pop();
        tamanioMax = 1;

        if (extensiones.indexOf(extension) !== -1) //verificamos si la extension esta en el arreglo
        {
             
            document.getElementById("tamanioarchivo").value =archivo.size / 1000000;

            if (archivo.size <= verTam(tamanioMax)) 
            {
                vistaimagen();
                vistaimagenoriginal();
                preguntasiedita();

            }
            else 
            {
                var aviso = document.getElementById("aviso")
                aviso.innerHTML = "Puede subir archivos hasta " + tamanioMax + "Mb como máximo.";
                $("#aviso").fadeIn(500);
                $("#aviso").fadeOut(5000);
                limpiarinputimagen();
                
                archivo.value = "";
            }
        }
        else 
        {
            aviso.innerHTML = "Solo se admiten archivos de tipo " + extensiones;
            $("#aviso").fadeIn(500);
            $("#aviso").fadeOut(5000);
            limpiarinputimagen();

            archivo.value = "";
        }
    }

    function vistaimagen() {

        var fr = new FileReader();
        var barra = document.getElementById("barra");
        muestra = document.getElementById("muestraoriginal");

        var valorbarra = document.getElementById("valorbarra");

        fr.onprogress = function (e) {
            barra.value = (e.loaded * 100 / e.total);
            valorbarra.innerHTML = Math.round(barra.value) + "%";
        }

        fr.onloadend = function (e) {
            muestra.src = fr.result;
            anchoenvista= muestra.width;
            altoenvista= muestra.height;

        }
        fr.readAsDataURL(archivo);

    }

    function vistaimagenoriginal(){
        //carga la imagen original
        var fro = new FileReader();
        original = document.getElementById("original");

        fro.onloadend = function (e) {
            original.src = fro.result;
            anchooriginal = original.width;
            altooriginal = original.height;
        }
        fro.readAsDataURL(archivo);
    }

     function subeimagenalservidor() {
        
        var tiporecorte = $('#escuadrada').prop('checked');
         
        
        var formulario = document.getElementById("formularioimagen");

        var formdata = new FormData(formulario);
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {

                 if (tiporecorte) {
                     buscarrecortecuadrado();
                } else {
                    buscarrecorterectangular();
                }

            } else {
                
                $('#muestraoriginal').hide();
                $('#seccionseleccion').hide();
                $('#carga').show();

                $('#carga').html('<div class="loading"><img src="cargando.gif" alt="loading" /><br/>Procesando el archivo</div>');
                
            }
        };
        xhttp.open('POST', 'subirimagenoriginal.php', true);
        xhttp.send(formdata);
    }

    function preguntasiedita()
    {
        const swalWithBootstrapButtons = Swal.mixin({
            customClass: {
                confirmButton: 'btn btn-success',
                cancelButton: 'btn btn-danger'
            },
            buttonsStyling: false
        })

        swalWithBootstrapButtons.fire({
            title: 'Desea usar esta imagen.',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Si',
            cancelButtonText: 'No',
            reverseButtons: true
        }).then((result) => {
            if (result.value) {
                subeimagenalservidor();
        
            } else if (

                result.dismiss === Swal.DismissReason.cancel
            ) {
                swalWithBootstrapButtons.fire(
                    'No hay problema !!!'
                )
            }
        })

    }
  
    function actualizacoordenadas(xx, yy, ww, hh) {

        document.getElementById("w").value = ww;
        document.getElementById("h").value = hh;

        //revisa el ancho y alto de la imagen a la vista y recalcula el factor
        var imgori = document.getElementById("muestraoriginal");

        anchoenvista = imgori.width;
        altoenvista = imgori.height;

        if (anchooriginal > anchoenvista) {
            factorescalaancho = anchooriginal / anchoenvista;
        }

        if (altooriginal > altoenvista) {
            factorescalaalto = altooriginal / altoenvista;
        }



        if(factorescalaancho > 0)
        {
            if(factorescalaancho>factorescalaalto){

                var xscalado = xx * factorescalaancho;
                var wscalado = ww * factorescalaancho;
            }else{
                var xscalado = xx * factorescalaalto;
                var wscalado = ww * factorescalaalto;
            }
        }else{
            var xscalado = xx;
            var wscalado = ww;
        }

        if(factorescalaalto > 0)
        {
            if (factorescalaancho > factorescalaalto)
            {
                var yscalado = yy * factorescalaancho;
                var hscalado = hh * factorescalaancho;
            }else{
                var yscalado = yy * factorescalaalto;
                var hscalado = hh * factorescalaalto;
            }
        }else
        {
            var yscalado = yy;
            var hscalado = hh;
        }
        tamanio = { x: xscalado, y: yscalado, w: wscalado, h: hscalado};
    }

    function avisopararecorte(){
         M.toast(
            {
                html: 'Ya puedes recortar la imagen!!',
                displayLength: '3000'
            });

        muestrarecortador = document.getElementById("muestraoriginal");
        muestrarecortador.src = "imagenesrecorte/" + archivo.name;
        $('#carga').hide();
        $('#muestraoriginal').show();
        $('#seccionrecorte').show();
    }


    function buscarrecorterectangular()
    {
        const stage = Jcrop.attach('muestraoriginal', {
            shadeColor: 'red',
            setSelect: [20, 20, 100, 100],
            onChange: updatePreview,
            onSelect: updatePreview
            
        });

      

        stage.active = true;

        stage.listen('crop.change', function (widget, e) {
            const pos = widget.pos;
            actualizacoordenadas(pos.x, pos.y, pos.w, pos.h);
        });


        stage.listen('crop.activate', function (widget, e) {
            const pos = widget.pos;
            actualizacoordenadas(pos.x, pos.y, pos.w, pos.h);
        });

        avisopararecorte();
       
    }

    function buscarrecortecuadrado() 
    {

        const stage = Jcrop.attach('muestraoriginal', {
            shadeColor: 'red', aspectRatio: 1
        });

        stage.active = true;

        stage.listen('crop.change', function (widget, e) {
            const pos = widget.pos;
            actualizacoordenadas(pos.x, pos.y, pos.w, pos.h);
        });


        stage.listen('crop.activate', function (widget, e) {
            const pos = widget.pos;
            actualizacoordenadas(pos.x, pos.y, pos.w, pos.h);
        });
       

        avisopararecorte();
        
    }

    function eliminararchivodeservidor(carpeta){

        $.ajax({
            url: "eliminararchivodeservidor.php",
            data: { carpeta: carpeta},
            type: "post",
            success: function(data)
            {
                if(data=="ok")
                {
                    // console.log("Papelera eliminada en el servidor");
                    Swal.fire({
                        text: 'Excelente, archivo descargado!!!'
                    })
                }
            },
            error: function(){
                alert("Error");
            }
        });
    }


    function activaseccionrecortada(){
        var img = $("#muestraoriginal").attr('src');
        $("#imagenrecortada").attr('src', 'imagenrecortada.php?x=' + tamanio.x + '&y=' + tamanio.y + '&w=' + tamanio.w + '&h=' + tamanio.h + '&img=' + img);
        
        $('#seccionrecortada').show();
        $('#secciondescarga').show();

        $('#seccionrecorte').hide();
        $('#seccionimagenprincipal').hide();
        

    }

    $("#recortar").click(function () {

        if(tamanio.w > 0 && tamanio.h > 0)
            activaseccionrecortada();        
        else
        Swal.fire({
            text: 'Debes arrastar en la imagen para seleccionar el recorte'
        })
    });

    function descargar() {
        var source = $("#imagenrecortada").attr('src');
        var a = document.createElement('a');
        a.download = true;
        a.target = '_blank';
        a.href = source;
        a.click();

        eliminararchivodeservidor("imagenesrecorte/");

    }

    $("#descargar").click(function () {
        descargar();
    });


    function limpiarinputimagen() {
        input = document.getElementById("imagen");
        input.value = '';
        input.innerHTML = "";
    }


    $("#nuevotijera").click(function(){
        
        location.reload();
        return false;
    });
   

</script>