<!DOCTYPE html>

<html>

<head>
        <!-- Required meta tags -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        
        <!-- autenticacion -->
        <script src="https://www.gstatic.com/firebasejs/ui/4.5.0/firebase-ui-auth.js"></script>
        <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/4.5.0/firebase-ui-auth.css" />
        
        <title>Templay Studios - Autenticación de usuario</title>
        
        <!-- Bootstrap CSS -->
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
            integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
        
        <!-- Materialize CSS -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
        
        <!-- estilos -->
        <link rel="icon" href="/img/icotemplay.png" type="image/png">
        <link href="https://fonts.googleapis.com/css2?family=Baloo+Da+2&display=swap" rel="stylesheet">
        <!-- <link rel="stylesheet" href="css/estilo2020.css"> -->

        
  
    <!-- Material Design Theming -->
    <link rel="stylesheet" href="https://code.getmdl.io/1.1.3/material.orange-indigo.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <script defer src="https://code.getmdl.io/1.1.3/material.min.js"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    <script type="text/javascript">
   

        // function actualizardatosusuario(apodo){
                //     var user = firebase.auth().currentUser;


                //     user.updateProfile({
                //         displayName: apodo,
                //         photoURL: "https://example.com/jane-q-user/profile.jpg"
                //     }).then(function () {
                //         // Update successful.
                //         swal("Actualizado!", "Ahora puede usar su apodo!");

                //     }, function (error) {
                //         // An error happened.
                //         swal("Error!", "Al actualizar su apodo!");

                //     });
                // }


        /**
         * INGRESO AL SISTEMA.
         */
        function toggleSignIn() {
            if (firebase.auth().currentUser) {
                // [START signout]
                firebase.auth().signOut();

                // [END signout]
            } else {
                var email = document.getElementById('email').value;
                var password = document.getElementById('password').value;
                if (email.length < 4) {
                    swal("Atención", "Ingrese una dirección de email!");
                    return;
                }
                if (password.length < 4) {
                    swal("Atención", "Ingrese una clave!");

                    return;
                }

                firebase.auth().signInWithEmailAndPassword(email, password).catch(function (error) {
                    var errorCode = error.code;
                    var errorMessage = error.message;
                    if (errorCode === 'auth/wrong-password') {
                        swal("Contraseña", "La clave es incorrecta.");
                    } else {
                        swal("Error", "No existe un usuario con este email");
                    }
                    console.log(error);
                    document.getElementById('quickstart-sign-in').disabled = false;
                });
            }
            document.getElementById('quickstart-sign-in').disabled = true;
        }

        /**
         * REGISTRO NUEVO EN EL SISTEMA.
         */

         function consultarusuario() {

            var email = document.getElementById('email').value;


            objeto = new Object();
            objeto.email = email.trim();
            objeto.tipo = "consultar";
            var objetojson = JSON.stringify(objeto);


            $.ajax({

                url: "controladores/usuariostemplay.php",
                data: { objetojson: objetojson },
                type: "post",

                success: function (data) {
                    
                    if (data == '[]') {
                        crearusuario();
                    } else if (data == "nobdd") {
                        console.log("No se conecto a la base de  datos");

                    } else if (data >= "1") {

                       
                        swal("Usuario!", "Ya existe alguien con este email!");
                        
                    } else {
                        console.log("Otro error " + data);
                    }


                },
                error: function (e) {
                    console.log("Error:" + e);
                }
            });
        }
        
         function crearusuario(){
            
            
             var email = document.getElementById('email').value;
             var password = document.getElementById('password').value;

            if (email.length < 4) {
                swal("Email", "Por favor ingrese una dirección de correo.");
                return;
            }
            if (password.length < 4) {
                swal("Contraseña", "Ingrese una clave de al menos 4 digitos");
                return;
            }


            objeto = new Object();
            objeto.email = email.trim();
            objeto.tipo = "alta";
            var objetojson = JSON.stringify(objeto);

            M.toast({ html: 'Trabajando...' });

            $.ajax({

                url:"controladores/usuariostemplay.php",
                data: {objetojson: objetojson},
                type: "post",

                success: function(data)
                {
                   if(data=="nobdd")
                    {
                        console.log("No se conecto a la base de  datos");
                   
                    }else if (data == "1"){
                        console.log("Usuario creado");
                        handleSignUp();
                        swal("Usuario Creado!", "Presione 'Verificar cuenta' para continuar!");

                    }else{
                        console.log("Otro error " + data);
                    }
                },
                error:function(e){
                    console.log("Error:" + e);
                }
            });
        }

        function verificarusuario() 
        {
            var email = document.getElementById('email').value;

            objeto = new Object();
            objeto.email = email.trim();
            objeto.tipo = "verificar";
            var objetojson = JSON.stringify(objeto);

            $.ajax({

                url: "controladores/usuariostemplay.php",
                data: { objetojson: objetojson },
                type: "post",

                success: function (data) {


                    if (data == "nobdd") {
                        console.log("No se conecto a la base de  datos");

                    } else if (data != "[]") {

                        
                        var dd = JSON.parse(data);
                        $.each(dd,function(key){
                           traerplataforma(dd[key].id);
                           
                        });
                        
                        firebase.auth().signOut();
                        
                    } else {
                        console.log("Otro error " + data);
                    }

                    
                },
                error: function (e) {
                    console.log("Error:" + e);
                }
            });
        }

        
        function handleSignUp() {
            
            var email = document.getElementById('email').value;
            var password = document.getElementById('password').value;
            document.getElementById('textoexplicacion').style.visibility = "visible";
            MandaEmail(email);
            

            firebase.auth().createUserWithEmailAndPassword(email, password).catch(function (error) {
                var errorCode = error.code;
                var errorMessage = error.message;
                if (errorCode == 'auth/weak-password') {
                    document.getElementById('textoexplicacion').style.visibility = "hidden";

                    eliminarusuario();
                    swal("Contraseña", "La clave es demasiado débil.");

                } else {
                    document.getElementById('textoexplicacion').style.visibility = "hidden";

                    eliminarusuario();
                    swal("Error", errorMessage);
                }
                console.log(error);
            });

         
        }

        function eliminarusuario() {

            var email = document.getElementById('email').value;

            objeto = new Object();
            objeto.email = email.trim();
            objeto.tipo = "baja";
            var objetojson = JSON.stringify(objeto);

            $.ajax({

                url: "controladores/usuariostemplay.php",
                data: { objetojson: objetojson },
                type: "post",

                success: function (data) {
                    if (data == "nobdd") {
                        console.log("No se conecto a la base de  datos");

                    } else if (data == "1") {
                        console.log("Usuario eliminado");
                    } else {
                        console.log("Otro error " + data);
                    }
                },
                error: function (e) {
                    console.log("Error:" + e);
                }
            });
        }
        
        arregloplataforma = [];

        function traerplataforma(id) {
            
            objeto = new Object();
            objeto.email = "";
            objeto.id = id;
            objeto.tipo = "plataforma";
            var objetojson = JSON.stringify(objeto);

            $.ajax({

                url: "controladores/usuariostemplay.php",
                data: { objetojson: objetojson },
                type: "post",

                success: function (data) 
                {
                    if (data != "[]")
                    {
                        dd = JSON.parse(data);
                        $.each(dd,function(key){

                           
                            dominio = dd[key].dominio;
                           
                        });
                        // abrirweb(dominio);
                        //window.location.replace("http://" + dominio + "/" + "panelpublicacion.php");
                        
                    }    
                },error: function(e){
                    console.log("Error " + e );
                }
            });
        } 

        function abrirweb(domi){
            var xhttp;

            if (window.XMLHttpRequest)
                xhttp = new XMLHttpRequest();
            else
                xhttp = new ActiveXObject("Microsoft.XMLHTTP");

            xhttp.onreadystatechange = function () {
                if (xhttp.readyState == 4 && xhttp.status == 200) {
                    // var elm = document.getElementById("nums").innerHTML = this.responseText;
                }
            }

            xhttp.open("POST", "http://" + domi + "/" + "panelpublicacion.php");
            xhttp.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            xhttp.send("permitido=1");
        }
        /**
         * Sends an email verification to the user.
         */
        function sendEmailVerification() {
            firebase.auth().currentUser.sendEmailVerification().then(function () {
                swal("Perfecto!", "Estás a un paso de conseguirlo, abre tu correo y verifica la cuenta!");
            });
            document.getElementById('quickstart-verify-email').style.visibility = "hidden";
            firebase.auth().signOut();
        }

        function sendPasswordReset() {
            var email = document.getElementById('email').value;
            firebase.auth().sendPasswordResetEmail(email).then(function () {
                swal("Enviado!", "Abra su email y resetee su clave!");
            }).catch(function (error) {
                var errorCode = error.code;
                var errorMessage = error.message;
                if (errorCode == 'auth/invalid-email') {
                    swal("Error", errorMessage);
                } else if (errorCode == 'auth/user-not-found') {
                    swal("Error", errorMessage);
                }
                console.log(error);
            });
        }

        function MandaEmail(email) {

            var emailnuevo = new FormData();
            var xhrnuevo = new XMLHttpRequest();
            xhrnuevo.open('POST', 'http://www.templaystudios.com/controladores/emailnuevousuario.php');
            xhrnuevo.withCredentials = true;

            emailnuevo.append('email', email);
            xhrnuevo.send(emailnuevo);

        }

        function initApp() {
            // Listening for auth state changes.
            firebase.auth().onAuthStateChanged(function (user) {
                document.getElementById('quickstart-verify-email').disabled = true;
                
            
                if (user) {
                    // User is signed in.
                    var displayName = user.displayName;
                    var email = user.email;
                    var emailVerified = user.emailVerified;
                    var photoURL = user.photoURL;
                    var isAnonymous = user.isAnonymous;
                    var uid = user.uid;
                    var providerData = user.providerData;

                    document.getElementById('quickstart-sign-in-status').textContent = 'Conectado';
                    document.getElementById('quickstart-sign-in').textContent = 'Salir';
                    
                    // document.getElementById('quickstart-account-details').textContent = JSON.stringify(user, null, '  ');
                    
                    if (!emailVerified) {
                        document.getElementById('quickstart-verify-email').disabled = false;
                    
                        document.getElementById('quickstart-verify-email').style.visibility = "visible";
                        document.getElementById('quickstart-password-reset').style.visibility = "hidden";
                    }else{
                        document.getElementById('quickstart-password-reset').style.visibility = "visible";
                        document.getElementById('quickstart-verify-email').style.visibility = "hidden";
                        document.getElementById('textoexplicacion').style.visibility = "hidden";
                        
                        verificarusuario();
                    }
                } else {
                    document.getElementById('quickstart-sign-in-status').textContent = 'Desconectado';
                    document.getElementById('quickstart-sign-in').textContent = 'Ingresar';
                    document.getElementById('quickstart-account-details').textContent = '';
                }
                document.getElementById('quickstart-sign-in').disabled = false;
            });

            document.getElementById('quickstart-sign-in').addEventListener('click', toggleSignIn, false);
            document.getElementById('quickstart-sign-up').addEventListener('click', consultarusuario, false);
            document.getElementById('quickstart-verify-email').addEventListener('click', sendEmailVerification, false);
            document.getElementById('quickstart-password-reset').addEventListener('click', sendPasswordReset, false);
        
        }

        window.onload = function () {
            initApp();
        };
    </script>
</head>

<!-- ---------------------------------------------- BODY ------------------------------------------------------ -->

<body>
    <div class="demo-layout mdl-layout mdl-js-layout mdl-layout--fixed-header">

    <div class="d-flex justify-content-center mt-2">
        <img src="img/templaystudiosmediano.jpg" class="img-fluid" alt="Responsive image" width="10%" height="auto">
    </div>
    <div class="d-flex justify-content-center mt-2">

    <input id="inputbase" type="text">
    </div>
    <div id="plataforma">
        <div  class="container">
            <div id="tarjeta" class="card text-center">
                <div class="card-header">
                    Autenticación
                </div>
                <div class="card-body">
                    <h5 class="card-title">Plataforma de trabajo</h5>
                    
                    <div class="d-flex justify-content-center mt-4 row">
                        <input class="mdl-textfield__input" style="display:inline;width:35%;" type="text" id="email" name="email"
                            placeholder="Email" />
                        &nbsp;&nbsp;&nbsp;
                        <input class="mdl-textfield__input" style="display:inline;width:auto;" type="password" id="password" name="password"
                            placeholder="Password" />
                        <br /><br />
                    </div>

                    <div class="d-flex justify-content-center mt-4 row">
                        <button disabled class="mdl-button mdl-js-button mdl-button--raised amber" id="quickstart-sign-in" name="signin">Ingresar</button>
                        &nbsp;&nbsp;&nbsp;
                    
                        <button class="mdl-button mdl-js-button mdl-button--raised" id="quickstart-sign-up" name="signup">Registrarse</button>
                        &nbsp;&nbsp;&nbsp;
                    </div>

                
                    <div class="d-flex justify-content-center row">
                        <button class="mdl-button mdl-js-button mdl-button--raised" disabled id="quickstart-verify-email"
                        name="verify-email" style="visibility: hidden;">Verificar cuenta</button>
                        &nbsp;&nbsp;&nbsp;
                    </div>
                    <div class="d-flex justify-content-center mt-1 row">
                        <button class="mdl-button mdl-js-button mdl-button--raised" id="quickstart-password-reset" name="verify-email">Resetear mi clave</button>
                    </div>
                    
                </div>
                <div class="card-footer text-muted">
                    <div class="d-flex justify-content-center row">
                        <p id="textoexplicacion" style="visibility: hidden;">Por seguridad te enviamos un correo para que verifiquemos que es tuya la cuenta.</p>
                    </div>
                    <!-- Container where we'll display the user details -->
                    <div class="quickstart-user-details-container">
                        Estado de conexión: <span id="quickstart-sign-in-status">Desconocido</span>
                        
                        <pre><code id="quickstart-account-details"> </code></pre>
                    </div>
                    
                </div>
            </div>
        </div>

    </div>
    <!-- ---------------------------------- Script externos ---------------------------------------------- -->
    
    
    <!-- Insert these scripts at the bottom of the HTML, but before you use any Firebase services -->
    
    <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/6.2.0/firebase-app.js"></script>
    
    <!-- Add Firebase products that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/6.2.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/6.2.0/firebase-firestore.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    

    <script>
        // Your web app's Firebase configuration
       var firebaseConfig = {
            apiKey: "AIzaSyAwy17hths5YGknlot758vbfJmdvUYxlhM",
            authDomain: "templay-studios.firebaseapp.com",
            databaseURL: "https://templay-studios.firebaseio.com",
            projectId: "templay-studios",
            storageBucket: "templay-studios.appspot.com",
            messagingSenderId: "794779272524",
            appId: "1:794779272524:web:81a2242dc1484162223be9",
            measurementId: "G-CYXV1DX5QB"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        // firebase.analytics();

    </script>
    
    
  
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
        integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
        crossorigin="anonymous"></script>

    <!-- <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script> -->


 
       <!-- MDB core JavaScript -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.8.11/js/mdb.min.js"></script>
    <!-- Compiled and minified JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <!-- para mostrar la tabla -->
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.js"></script>
    <!-- para mostrar los toast -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@9.4.3/dist/sweetalert2.all.min.js"></script>


</body>

</html>

